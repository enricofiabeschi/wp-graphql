name: Release Version

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release tag (e.g. v1.0.0 or v2.6.0-lava1)"
        required: true

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout dist
        uses: actions/checkout@v6
        with:
          ref: dist
          fetch-depth: 0

      - name: Validate version tag format
        run: |
          set -e
          TAG="${{ inputs.version }}"
          echo "$TAG" | grep -Eq '^v[0-9]+(\.[0-9]+){1,2}([+.-][0-9A-Za-z.-]+)?$' \
          || (echo "Invalid tag: $TAG. Examples: v1.0.0, v2.6.0-lava1" && exit 1)

      - name: Fail if tag already exists
        run: |
          set -e
          TAG="${{ inputs.version }}"
          git fetch --tags
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag already exists: $TAG"
            exit 1
          fi

      - name: Setup PHP (Composer)
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.2
          tools: composer:v2
          coverage: none

      - name: Setup Node.js (>=22 required)
        uses: actions/setup-node@v6
        with:
          node-version: "22"

      - name: Install PHP dependencies (dist)
        working-directory: plugins/wp-graphql
        run: composer install --no-dev --optimize-autoloader --no-interaction --no-progress

      - name: Install Node deps + build assets
        run: |
          npm ci
          npm run -w @wpgraphql/wp-graphql build

      - name: Create plugin zip (respects .distignore)
        working-directory: plugins/wp-graphql
        run: composer run-script zip

      - name: Create git tag on HEAD of main
        run: |
          set -e
          TAG="${{ inputs.version }}"
          git tag "$TAG"
          git push origin "$TAG"

      - name: Create GitHub Release + upload zip
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.version }}
          name: ${{ inputs.version }}
          files: plugin-build/wp-graphql.zip
